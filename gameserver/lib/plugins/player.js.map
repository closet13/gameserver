{"version":3,"sources":["../../src/plugins/player.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;8BAMwB,qBAAqB;;;;AAF7C,IAAI,OAAO,GAAG,OAAO,CAAC,YAAY,CAAC,CAAC;AACpC,IAAI,MAAM,GAAG,OAAO,CAAC,aAAa,CAAC,CAAC,MAAM,CAAC;;AAE3C,IAAI,CAAC,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;;IAEpB,MAAM;cAAN,MAAM;;AACG,aADT,MAAM,GACM;8BADZ,MAAM;;AAEJ,mCAFF,MAAM,6CAEI;AACR,YAAI,CAAC,EAAE,CAAC,YAAY,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;KACzC;;iBAJC,MAAM;;eAMD,iBAAC,EAAE,EAAE;AACR,gBAAI,CAAC,MAAM,CAAC,IAAI,CAAC,uBAAuB,CAAC,CAAC;AAC1C,gBAAI,CAAC,EAAE,GAAG,EAAE,CAAC;AACb,gBAAI,CAAC,EAAE,CAAC,iBAAiB,EAAE,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;AAC1D,gBAAI,CAAC,EAAE,CAAC,QAAQ,EAAE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;SAE/C;;;eAEY,uBAAC,MAAM,EAAE,CAAC,EAAE;;AAErB,gBAAI,MAAM,GAAG,gCAAgB;AACzB,mBAAG,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,EAAE;AACrB,qBAAK,EAAE,CAAC,CAAC,KAAK;AACd,sBAAM,EAAE,MAAM;AACd,oBAAI,EAAE;AACF,4BAAQ,EAAE,CAAC,CAAC,QAAQ;AACpB,uBAAG,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,EAAE;AACrB,0BAAM,EAAE,GAAG;iBACd;AACD,iBAAC,EAAE;AACC,uBAAG,EAAE,EAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAC;AACvB,uBAAG,EAAE,CAAC;iBACT;aACJ,CAAC,CAAC;AACH,kBAAM,CAAC,MAAM,GAAG,MAAM,CAAC;AACvB,gBAAI,CAAC,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;;AAE9B,kBAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC;AACnC,gBAAI,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,cAAc,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC;;AAE1D,aAAC,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,QAAQ,EAAE,UAAC,EAAE,EAAI;AAC9B,uBAAO,MAAM,CAAC,GAAG,IAAI,EAAE,CAAC,GAAG,CAAC;aAC/B,CAAC,CAAC,OAAO,CAAC,UAAC,EAAE,EAAI;AACd,sBAAM,CAAC,MAAM,CAAC,IAAI,CAAC,cAAc,EAAE,EAAE,CAAC,IAAI,CAAC,CAAC;;AAE5C,sBAAM,CAAC,IAAI,CAAC,qBAAqB,EAAE;AAC/B,uBAAG,EAAE,EAAE,CAAC,GAAG;AACX,uBAAG,EAAE,EAAE,CAAC,CAAC,CAAC,GAAG;AACb,uBAAG,EAAE,EAAE,CAAC,CAAC,CAAC,GAAG;iBAChB,CAAC,CAAC;aACN,CAAC,CAAC;;AAEH,kBAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;;AAErB,gBAAI,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;SAG3B;;;eAEY,uBAAC,CAAC,EAAE;;AAEb,gBAAI,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,QAAQ,EAAE,EAAC,GAAG,EAAE,CAAC,CAAC,GAAG,EAAC,CAAC,CAAC;AAC/C,aAAC,CAAC,CAAC,GAAG,CAAC,CAAC;;AAER,aAAC,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,QAAQ,EAAE,UAAC,CAAC,EAAI;AAC7B,uBAAO,CAAC,CAAC,GAAG,IAAI,CAAC,CAAC,GAAG,CAAC;aACzB,CAAC,CAAC,OAAO,CAAC,UAAC,CAAC,EAAI;AACb,iBAAC,CAAC,MAAM,CAAC,IAAI,CAAC,qBAAqB,EAAE,CAAC,CAAC,CAAC;aAC3C,CAAC,CAAC;SACN;;;eAEQ,mBAAC,MAAM,EAAE;;;AACd,gBAAI,CAAC,MAAM,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC;AACpC,kBAAM,CAAC,EAAE,CAAC,OAAO,EAAE,UAAC,IAAI,EAAI;AACxB,uBAAO,CACF,IAAI,CAAC,MAAK,EAAE,CAAC,OAAO,CAAC,cAAc,GAAG,MAAK,EAAE,CAAC,OAAO,CAAC,wBAAwB,CAAC,CAC/E,IAAI,CAAC,EAAC,KAAK,EAAE,IAAI,CAAC,KAAK,EAAC,CAAC,CACzB,GAAG,CAAC,UAAC,GAAG,EAAE,IAAI,EAAI;AACf,wBAAI,GAAG,EAAE,MAAK,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,KAC9B;;;AAED,gCAAI,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;AACrB,kCAAK,EAAE,CAAC,GAAG,CAAC,MAAM,CAAC,OAAO,CAAC,EAAC,QAAQ,EAAE,IAAI,CAAC,QAAQ,EAAC,EAAE,sBAAsB,CAAC,CACxE,IAAI,CAAC,UAAC,GAAG,EAAE,IAAI,EAAI;AAChB,oCAAI,CAAC,IAAI,EAAE;AACP,wCAAI,CAAC,GAAG,IAAI,MAAK,EAAE,CAAC,GAAG,CAAC,MAAM,CAAC;AAC3B,gDAAQ,EAAE,IAAI,CAAC,QAAQ;AACvB,6CAAK,EAAE,IAAI,CAAC,KAAK;AACjB,4CAAI,EAAE,EAAE;qCACX,CAAC,CAAC,IAAI,CAAC,UAAC,GAAG,EAAE,MAAM,EAAI;;AAEhB,8CAAK,aAAa,CAAC,MAAM,EAAE,MAAM,CAAC,QAAQ,EAAE,CAAC,CAAC;qCACjD,CAAC,CAAA;iCACT,MAAM;AACH,0CAAK,aAAa,CAAC,MAAM,EAAE,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC;iCAC/C;6BAEJ,CAAC,CAAA;;qBACT;iBACJ,CAAC,CAAC;aACV,CAAC,CAAC;AACH,kBAAM,CAAC,EAAE,CAAC,YAAY,EAAE,YAAK;;AAEzB,oBAAI,MAAM,CAAC,MAAM,EAAE;AACf,qBAAC,CAAC,MAAM,CAAC,MAAK,EAAE,CAAC,QAAQ,EAAE,EAAC,GAAG,EAAE,MAAM,CAAC,MAAM,CAAC,GAAG,EAAC,CAAC,CAAC;;AAErD,0BAAK,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,EAAE,EAAC,GAAG,EAAE,MAAM,CAAC,MAAM,CAAC,GAAG,EAAC,CAAC,CAAC;iBAC1D;;AAED,sBAAM,GAAG,IAAI,CAAC;aACjB,CAAC,CAAC;SACN;;;eAEO,kBAAC,IAAI,EAAE,MAAM,EAAE;AACnB,gBAAI,CAAC,MAAM,GAAG,MAAM,CAAC,GAAG,CAAC;;AAEzB,aAAC,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC,QAAQ,EAAE,UAAC,CAAC,EAAI;AAC9B,oBAAI,CAAC,CAAC,GAAG,IAAI,MAAM,CAAC,GAAG,EAAE;;AAErB,qBAAC,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;iBAC/B;aACJ,CAAC,CAAC;SACN;;;eAES,oBAAC,MAAM,EAAE;;;AACf,gBAAI,IAAI,GAAG;AACP,sBAAM,EAAE,MAAM,CAAC,GAAG;AAClB,mBAAG,EAAE,CACD,EAAC,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE,UAAU,EAAE,CAAC,EAAE,MAAM,CAAC,IAAI,CAAC,MAAM,EAAC,CACtD;aACJ,CAAC;AACF,gBAAI,CAAC,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;AAC/B,gBAAI,MAAM,CAAC,IAAI,CAAC,MAAM,IAAI,CAAC,EAAE;AACzB,oBAAI,CAAC,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,KAAK,EAAE,EAAC,GAAG,EAAE,MAAM,CAAC,GAAG,EAAC,CAAC,CAAC;AAC3C,0BAAU,CAAC,YAAK;AACZ,2BAAK,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,SAAS,EAAE,EAAC,GAAG,EAAE,MAAM,CAAC,GAAG,EAAC,CAAC,CAAC;AAC/C,0BAAM,CAAC,IAAI,CAAC,MAAM,GAAG,GAAG,CAAC;AACzB,2BAAK,UAAU,CAAC,MAAM,CAAC,CAAC;iBAC3B,EAAE,IAAI,CAAC,CAAC;aACZ;SACJ;;;WAxIC,MAAM;GAAS,MAAM;;AA6I3B,MAAM,CAAC,OAAO,GAAG,GAAG,CAAC;;AAErB,MAAM,CAAC,OAAO,CAAC,MAAM,GAAG,MAAM,CAAC","file":"player.js","sourcesContent":["/**\n * Created by santi8ago8 on 09/03/15.\n */\n\nlet request = require('superagent');\nvar Plugin = require('./../plugin').Plugin;\nimport PlayerClass from '../engine/player.js';\nlet _ = require('lodash');\n\nclass Player extends Plugin {\n    constructor() {\n        super();\n        this.on('connection', this.connected);\n    }\n\n    enabled(gs) {\n        this.logger.info('Player plugin enabled');\n        this.gs = gs;\n        this.on('s:syncTransform', this.syncTransform.bind(this));\n        this.on('s:sync', this.syncVars.bind(this));\n\n    }\n\n    emitConnected(socket, p) {\n\n        let player = new PlayerClass({\n            _id: p._id.toString(),\n            token: p.token,\n            socket: socket,\n            data: {\n                username: p.username,\n                _id: p._id.toString(),\n                health: 100,\n            },\n            t: {\n                pos: {x: 0, y: 0, z: 0},\n                rot: 0\n            }\n        });\n        socket.player = player;\n        this.gs._players.push(player);\n\n        socket.emit('player', player.data);\n        this.gs._io.to('lobby').emit('onlinePlayer', player.data);\n\n        _.filter(this.gs._players, (el)=> {\n            return player._id != el._id;\n        }).forEach((el)=> {\n            player.socket.emit('onlinePlayer', el.data);\n\n            socket.emit('syncTransformClient', {\n                _id: el._id,\n                pos: el.t.pos,\n                rot: el.t.rot\n            });\n        });\n\n        socket.join('lobby');\n\n        this.syncHealth(player);\n\n\n    }\n\n    syncTransform(t) {\n        //this.logger.info(t);\n        let p = _.find(this.gs._players, {_id: t._id});\n        p.t = t;\n\n        _.filter(this.gs._players, (p)=> {\n            return p._id != t._id;\n        }).forEach((p)=> {\n            p.socket.emit('syncTransformClient', t);\n        });\n    }\n\n    connected(socket) {\n        this.logger.info('connectedddd!!!');\n        socket.on('login', (data)=> {\n            request\n                .post(this.gs._config.loginServerUrl + this.gs._config.loginServerUrlCheckToken)\n                .send({token: data.token})\n                .end((err, resp)=> {\n                    if (err) this.gs.logger.error(err);\n                    else {\n                        //body.username\n                        let body = resp.body;\n                        this.gs._db.Player.findOne({username: body.username}, {/*TODO: projection*/})\n                            .exec((err, resp)=> {\n                                if (!resp) {\n                                    let p = new this.gs._db.Player({\n                                        username: body.username,\n                                        token: data.token,\n                                        meta: {}\n                                    }).save((err, player)=> {\n\n                                            this.emitConnected(socket, player.toObject());\n                                        })\n                                } else {\n                                    this.emitConnected(socket, resp.toObject());\n                                }\n\n                            })\n                    }\n                });\n        });\n        socket.on('disconnect', ()=> {\n\n            if (socket.player) {\n                _.remove(this.gs._players, {_id: socket.player._id});\n                //emit disconnect, client.\n                this.gs._io.emit('deonline', {_id: socket.player._id});\n            }\n\n            socket = null;\n        });\n    }\n\n    syncVars(data, player) {\n        data.sender = player._id;\n\n        _.forEach(this.gs._players, (p)=> {\n            if (p._id != player._id) {\n                //this.logger.debug('to', p._id);\n                p.socket.emit('sync', data);\n            }\n        });\n    }\n\n    syncHealth(player) {\n        var data = {\n            sender: player._id,\n            els: [\n                {n: 'health', b: 'PlayerUI', v: player.data.health}\n            ]\n        };\n        this.gs._io.emit('sync', data);\n        if (player.data.health <= 0) {\n            this.gs._io.emit('die', {_id: player._id});\n            setTimeout(()=> {\n                this.gs._io.emit('respawn', {_id: player._id});\n                player.data.health = 100;\n                this.syncHealth(player);\n            }, 5000);\n        }\n    }\n\n}\n\n\nPlayer.version = 0.1;\n\nmodule.exports.Player = Player;"]}